name: CD - Development Deploy

on:
  push:
    branches:
      - release/development

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Development Server
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "===== START DEPLOYMENT ====="

            cd /var/www/payment-aggregator-be || exit 1

            echo "Updating source code..."
            git fetch origin
            git checkout release/development
            git reset --hard origin/release/development
            git clean -fd

            echo "Loading environment variables..."
            set -a
            source .env
            set +a

            echo "Installing dependencies..."
            rm -rf vendor
            COMPOSER_ALLOW_SUPERUSER=1 composer install \
              --prefer-dist \
              --optimize-autoloader \
              --no-interaction

            echo "Clearing old Laravel cache..."
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan cache:clear || true

            if [ "$APP_ENV" = "development" ]; then
              echo "===== BACKUP DATABASE ====="

              BACKUP_DIR="./backup/db"
              mkdir -p "$BACKUP_DIR"
              TIMESTAMP=$(date +%F_%H-%M-%S)

              if [ "$DB_CONNECTION" = "pgsql" ]; then
                echo "Backing up PostgreSQL..."
                export PGPASSWORD="$DB_PASSWORD"
                pg_dump \
                  -U "$DB_USERNAME" \
                  -h "$DB_HOST" \
                  -p "${DB_PORT:-5432}" \
                  -d "$DB_DATABASE" \
                  --no-owner \
                  --no-acl \
                  -F c \
                  -f "$BACKUP_DIR/db_$TIMESTAMP.dump"

              elif [ "$DB_CONNECTION" = "mysql" ]; then
                echo "Backing up MySQL..."
                mysqldump \
                  -h "$DB_HOST" \
                  -P "${DB_PORT:-3306}" \
                  -u "$DB_USERNAME" \
                  -p"$DB_PASSWORD" \
                  --single-transaction \
                  --quick \
                  --lock-tables=false \
                  "$DB_DATABASE" > "$BACKUP_DIR/db_$TIMESTAMP.sql"

              else
                echo "Unsupported DB driver: $DB_CONNECTION"
              fi

              echo "Cleaning backups older than 7 days..."
              find "$BACKUP_DIR" -type f -mtime +7 -delete
            fi

            echo "Running migrations..."
            php artisan migrate --force

            echo "Rebuilding Laravel cache..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "Reloading PM2 (zero downtime)..."
            pm2 reload ecosystem.config.cjs --env development || pm2 start ecosystem.config.cjs
            pm2 save

            echo "===== DEPLOYMENT COMPLETE ====="
